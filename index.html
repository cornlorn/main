<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- SEO Improvements -->
    <meta name="description" content="Cloxious - A social feed for sharing your thoughts." />
    <meta name="keywords" content="social, posts, feed, share, thoughts, cloxious" />
    <meta name="robots" content="index, follow" />
    <title>Cloxious</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e"
              }
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite"
            }
          }
        }
      };
    </script>
    <script>
      // Translations for the application (only en, es, and it remain)
      const translations = {
        en: {
          socialFeed: "Cloxious",
          shareThoughts: "Share your thoughts",
          yourName: "Your name",
          whatsOnMind: "What's on your mind?",
          ctrlEnterToPost: "Press Ctrl+Enter to post",
          post: "Post",
          posting: "Posting...",
          recentPosts: "Recent Posts",
          loading: "Loading...",
          loadMore: "Load More",
          noPostsYet: "No posts yet",
          beFirstToShare: "Be the first to share something!",
          anonymous: "Anonymous",
          copyright: "© 2025 Cloxious. All rights reserved.",
          postEmpty: "Post cannot be empty.",
          postTooLong: "Post must be less than 512 characters.",
          nameRequired: "Name is required.",
          postSubmitSuccess: "Post submitted successfully!",
          postSubmitFailed: "Failed to submit post.",
          loadPostsFailed: "Failed to load posts. Please try again.",
          errorSubmitting: "Error submitting post. Please try again.",
          actionFailed: "Action failed. Please try again.",
          like: "Like",
          dislike: "Dislike",
          likes: "Likes",
          dislikes: "Dislikes",
          // Time label translations
          second: "second",
          seconds: "seconds",
          minute: "minute",
          minutes: "minutes",
          hour: "hour",
          hours: "hours"
        },
        es: {
          socialFeed: "Cloxious",
          shareThoughts: "Comparte tus pensamientos",
          yourName: "Tu nombre",
          whatsOnMind: "¿Qué estás pensando?",
          ctrlEnterToPost: "Presiona Ctrl+Enter para publicar",
          post: "Publicar",
          posting: "Publicando...",
          recentPosts: "Publicaciones Recientes",
          loading: "Cargando...",
          loadMore: "Cargar Más",
          noPostsYet: "Aún no hay publicaciones",
          beFirstToShare: "¡Sé el primero en compartir algo!",
          anonymous: "Anónimo",
          copyright: "© 2025 Cloxious. Todos los derechos reservados.",
          postEmpty: "La publicación no puede estar vacía.",
          postTooLong: "La publicación debe tener menos de 512 caracteres.",
          nameRequired: "El nombre es obligatorio.",
          postSubmitSuccess: "¡Publicación enviada con éxito!",
          postSubmitFailed: "Error al enviar la publicación.",
          loadPostsFailed: "Error al cargar las publicaciones. Inténtalo de nuevo.",
          errorSubmitting: "Error al enviar la publicación. Inténtalo de nuevo.",
          actionFailed: "La acción falló. Por favor, inténtalo de nuevo.",
          like: "Me gusta",
          dislike: "No me gusta",
          likes: "Me gusta",
          dislikes: "No me gusta",
          second: "segundo",
          seconds: "segundos",
          minute: "minuto",
          minutes: "minutos",
          hour: "hora",
          hours: "horas"
        },
        it: {
          socialFeed: "Cloxious",
          shareThoughts: "Condividi i tuoi pensieri",
          yourName: "Il tuo nome",
          whatsOnMind: "A cosa stai pensando?",
          ctrlEnterToPost: "Premi Ctrl+Enter per pubblicare",
          post: "Pubblica",
          posting: "Pubblicando...",
          recentPosts: "Post Recenti",
          loading: "Caricamento...",
          loadMore: "Carica Altri",
          noPostsYet: "Ancora nessun post",
          beFirstToShare: "Sii il primo a condividere qualcosa!",
          anonymous: "Anonimo",
          copyright: "© 2025 Cloxious. Tutti i diritti riservati.",
          postEmpty: "Il post non può essere vuoto.",
          postTooLong: "Il post deve avere meno di 512 caratteri.",
          nameRequired: "Il nome è obbligatorio.",
          postSubmitSuccess: "Post inviato con successo!",
          postSubmitFailed: "Impossibile inviare il post.",
          loadPostsFailed: "Impossibile caricare i post. Riprova.",
          errorSubmitting: "Errore durante l'invio del post. Riprova.",
          actionFailed: "Azione fallita. Per favore riprova.",
          like: "Mi piace",
          dislike: "Non mi piace",
          likes: "Mi piace",
          dislikes: "Non mi piace",
          second: "secondo",
          seconds: "secondi",
          minute: "minuto",
          minutes: "minuti",
          hour: "ora",
          hours: "ore"
        }
      };

      function getUserLanguage() {
        const browserLang = navigator.language.split("-")[0];
        return translations[browserLang] ? browserLang : "en";
      }

      function t(key) {
        const lang = getUserLanguage();
        return translations[lang][key] || translations["en"][key] || key;
      }
    </script>
    <script>
      // Time formatting function with singular/plural labels
      function formatTimeDifference(utcDateString) {
        const isoDateString = utcDateString.replace(" ", "T") + "Z";
        const utcDate = new Date(isoDateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - utcDate) / 1000);

        if (diffInSeconds < 60) {
          return `${diffInSeconds} ${diffInSeconds === 1 ? t("second") : t("seconds")} ago`;
        }
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
          return `${diffInMinutes} ${diffInMinutes === 1 ? t("minute") : t("minutes")} ago`;
        }
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
          return `${diffInHours} ${diffInHours === 1 ? t("hour") : t("hours")} ago`;
        }

        const currentYear = now.getFullYear();
        const postYear = utcDate.getFullYear();
        const locale = navigator.language;
        const options = { month: "long", day: "numeric" };
        if (currentYear !== postYear) {
          options.year = "numeric";
        }
        return utcDate.toLocaleDateString(locale, options);
      }

      let page = 1;
      const limit = 10;
      let isSubmitting = false;
      let isLoading = false;

      async function fetchPosts(loadMore = false) {
        if (isLoading) return;
        isLoading = true;
        toggleLoadingState(true);
        try {
          const response = await fetch(`https://cloxious.cloxious.workers.dev/posts?page=${page}&limit=${limit}`);
          const data = await response.json();
          const postList = document.getElementById("post-list");
          if (!loadMore) {
            postList.innerHTML = "";
          }
          if (data.results.length === 0 && !loadMore) {
            postList.innerHTML = `
              <div class="flex flex-col items-center justify-center py-12 text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <p class="text-lg font-medium">${t("noPostsYet")}</p>
                <p class="mt-1">${t("beFirstToShare")}</p>
              </div>
            `;
          } else {
            data.results.forEach((post) => {
              // Wrap each post in an anchor that points to post.html?id=post.id
              const anchor = document.createElement("a");
              anchor.href = `post.html?id=${post.id}`;
              anchor.className = "block no-underline text-current";
              anchor.innerHTML = `
                <div class="p-5 border border-gray-200 rounded-lg bg-white mb-4 shadow-sm hover:shadow-md transition-shadow duration-200">
                  <div class="flex items-start">
                    <div class="flex-shrink-0 mr-3">
                      <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 font-bold">
                        ${post.author ? post.author.charAt(0).toUpperCase() : "?"}
                      </div>
                    </div>
                    <div class="flex-1">
                      <div class="flex items-center mb-1">
                        <h3 class="font-medium text-gray-900">${post.author || t("anonymous")}</h3>
                      </div>
                      <p class="text-gray-800 whitespace-pre-wrap break-words">${post.content}</p>
                      <div class="mt-2 flex items-center justify-between">
                        <div class="flex items-center text-gray-500 text-sm">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          <span>${formatTimeDifference(post.created_at)}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                          <div class="flex items-center">
                            <button id="like-${post.id}" onclick="likePost('${
                post.id
              }'); event.preventDefault();" class="inline-flex items-center p-1 rounded-md text-gray-500 hover:text-green-600 hover:bg-green-50 transition-colors duration-200" aria-label="${t(
                "like"
              )}">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9" />
                              </svg>
                            </button>
                            <span id="like-count-${post.id}" class="text-sm ml-1">${post.likes || 0}</span>
                          </div>
                          <div class="flex items-center">
                            <button id="dislike-${post.id}" onclick="dislikePost('${
                post.id
              }'); event.preventDefault();" class="inline-flex items-center p-1 rounded-md text-gray-500 hover:text-red-600 hover:bg-red-50 transition-colors duration-200" aria-label="${t(
                "dislike"
              )}">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5" />
                              </svg>
                            </button>
                            <span id="dislike-count-${post.id}" class="text-sm ml-1">${post.dislikes || 0}</span>
                          </div>
                          <!-- Display comment count -->
                          <div class="flex items-center text-gray-500 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m-2 8a9 9 0 110-18 9 9 0 010 18z" />
                            </svg>
                            <span>${post.comment_count || 0} ${post.comment_count === 1 ? "Comment" : "Comments"}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              `;
              postList.appendChild(anchor);
            });
          }
          if (data.results.length === limit) {
            document.getElementById("load-more").classList.remove("hidden");
          } else {
            document.getElementById("load-more").classList.add("hidden");
          }
        } catch (error) {
          console.error("Error fetching posts:", error);
          document.getElementById("error-message").textContent = t("loadPostsFailed");
          document.getElementById("error-alert").classList.remove("hidden");
          setTimeout(() => {
            document.getElementById("error-alert").classList.add("hidden");
          }, 5000);
        } finally {
          isLoading = false;
          toggleLoadingState(false);
        }
      }

      async function submitPost() {
        if (isSubmitting) return;
        const textarea = document.getElementById("post-text");
        const authorInput = document.getElementById("author-name");
        const content = textarea.value.trim();
        const author = authorInput.value.trim();
        const charCount = document.getElementById("char-count");
        const submitBtn = document.getElementById("submit-btn");
        if (content.length === 0) {
          showError(t("postEmpty"));
          return;
        }
        if (content.length > 512) {
          showError(t("postTooLong"));
          return;
        }
        if (author.length === 0) {
          showError(t("nameRequired"));
          return;
        }
        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
          <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          ${t("posting")}
        `;
        try {
          const response = await fetch("https://cloxious.cloxious.workers.dev/posts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content, author })
          });
          if (response.ok) {
            textarea.value = "";
            updateCharCount();
            page = 1;
            await fetchPosts();
            showSuccess(t("postSubmitSuccess"));
          } else {
            showError(t("postSubmitFailed"));
          }
        } catch (error) {
          console.error("Error submitting post:", error);
          showError(t("errorSubmitting"));
        } finally {
          isSubmitting = false;
          submitBtn.disabled = false;
          submitBtn.innerHTML = t("post");
        }
      }

      function loadMorePosts() {
        page++;
        fetchPosts(true);
      }

      function updateCharCount() {
        const textarea = document.getElementById("post-text");
        const charCount = document.getElementById("char-count");
        const count = textarea.value.length;
        charCount.textContent = `${count}/512`;
        if (count > 512) {
          charCount.classList.add("text-red-500");
          charCount.classList.remove("text-gray-500");
        } else if (count > 450) {
          charCount.classList.add("text-yellow-500");
          charCount.classList.remove("text-gray-500", "text-red-500");
        } else {
          charCount.classList.add("text-gray-500");
          charCount.classList.remove("text-red-500", "text-yellow-500");
        }
      }

      function toggleLoadingState(isLoading) {
        const loadingIndicator = document.getElementById("loading-indicator");
        const loadMoreBtn = document.getElementById("load-more");
        if (isLoading) {
          loadingIndicator.classList.remove("hidden");
          if (page > 1) {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = `
              <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              ${t("loading")}
            `;
          }
        } else {
          loadingIndicator.classList.add("hidden");
          if (page > 1) {
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = t("loadMore");
          }
        }
      }

      function showError(message) {
        const errorAlert = document.getElementById("error-alert");
        const errorMessage = document.getElementById("error-message");
        errorMessage.textContent = message;
        errorAlert.classList.remove("hidden");
        setTimeout(() => {
          errorAlert.classList.add("hidden");
        }, 5000);
      }

      function showSuccess(message) {
        const successAlert = document.getElementById("success-alert");
        const successMessage = document.getElementById("success-message");
        successMessage.textContent = message;
        successAlert.classList.remove("hidden");
        setTimeout(() => {
          successAlert.classList.add("hidden");
        }, 3000);
      }

      function handleKeyDown(event) {
        if (event.key === "Enter" && (event.ctrlKey || event.metaKey)) {
          submitPost();
        }
      }

      window.onload = () => {
        fetchPosts();
        document.getElementById("post-text").addEventListener("input", updateCharCount);
        document.getElementById("post-text").addEventListener("keydown", handleKeyDown);
        updateCharCount();
        document.getElementById("app-title").textContent = t("socialFeed");
        document.getElementById("share-thoughts").textContent = t("shareThoughts");
        document.getElementById("author-name").placeholder = t("yourName");
        document.getElementById("post-text").placeholder = t("whatsOnMind");
        document.getElementById("keyboard-shortcut").textContent = t("ctrlEnterToPost");
        document.getElementById("submit-btn").textContent = t("post");
        document.getElementById("recent-posts").textContent = t("recentPosts");
        document.getElementById("loading-text").textContent = t("loading");
        document.getElementById("load-more").textContent = t("loadMore");
        document.getElementById("copyright").textContent = t("copyright");
      };
    </script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-sm">
      <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary-500" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
              <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
            </svg>
            <h1 class="ml-2 text-xl font-bold text-gray-800" id="app-title">Cloxious</h1>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Post Submission Form -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
        <div class="p-5">
          <h2 class="text-lg font-semibold text-gray-800 mb-3" id="share-thoughts">Share your thoughts</h2>
          <div class="mb-3">
            <input
              type="text"
              id="author-name"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-300 focus:border-primary-500 transition-colors duration-200"
              placeholder="Your name"
              required
            />
          </div>
          <div class="relative">
            <textarea
              id="post-text"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-300 focus:border-primary-500 transition-colors duration-200 resize-none"
              rows="3"
              maxlength="512"
              placeholder="What's on your mind?"
            ></textarea>
            <div class="absolute bottom-3 right-3">
              <span id="char-count" class="text-xs text-gray-500">0/512</span>
            </div>
          </div>
          <div class="mt-3 flex justify-between items-center">
            <div class="text-xs text-gray-500" id="keyboard-shortcut">Press Ctrl+Enter to post</div>
            <button
              id="submit-btn"
              onclick="submitPost()"
              class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors duration-200 flex items-center"
            >
              Post
            </button>
          </div>
        </div>
      </div>

      <!-- Posts Section -->
      <div>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-800" id="recent-posts">Recent Posts</h2>
          <div id="loading-indicator" class="hidden">
            <div class="flex items-center text-primary-600">
              <svg class="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span id="loading-text">Loading...</span>
            </div>
          </div>
        </div>

        <div id="post-list" class="space-y-4"></div>

        <div class="mt-6 text-center">
          <button
            id="load-more"
            onclick="loadMorePosts()"
            class="px-6 py-2.5 bg-gray-700 text-white rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors duration-200 hidden"
          >
            Load More
          </button>
        </div>
      </div>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-10">
      <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <p class="text-center text-sm text-gray-500" id="copyright">&copy; 2025 Cloxious. All rights reserved.</p>
      </div>
    </footer>
  </body>
</html>
