<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Social Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e"
              }
            },
            animation: {
              "pulse-slow": "pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite"
            }
          }
        }
      };
    </script>
    <script>
      // Translations for the application
      const translations = {
        en: {
          socialFeed: "Cloxious",
          shareThoughts: "Share your thoughts",
          yourName: "Your name",
          whatsOnMind: "What's on your mind?",
          ctrlEnterToPost: "Press Ctrl+Enter to post",
          post: "Post",
          posting: "Posting...",
          recentPosts: "Recent Posts",
          loading: "Loading...",
          loadMore: "Load More",
          noPostsYet: "No posts yet",
          beFirstToShare: "Be the first to share something!",
          anonymous: "Anonymous",
          copyright: "© 2025 Cloxious. All rights reserved.",
          // Validation messages
          postEmpty: "Post cannot be empty.",
          postTooLong: "Post must be less than 512 characters.",
          nameRequired: "Name is required.",
          postSubmitSuccess: "Post submitted successfully!",
          postSubmitFailed: "Failed to submit post.",
          loadPostsFailed: "Failed to load posts. Please try again.",
          errorSubmitting: "Error submitting post. Please try again."
        },
        es: {
          socialFeed: "Cloxious",
          shareThoughts: "Comparte tus pensamientos",
          yourName: "Tu nombre",
          whatsOnMind: "¿Qué estás pensando?",
          ctrlEnterToPost: "Presiona Ctrl+Enter para publicar",
          post: "Publicar",
          posting: "Publicando...",
          recentPosts: "Publicaciones Recientes",
          loading: "Cargando...",
          loadMore: "Cargar Más",
          noPostsYet: "Aún no hay publicaciones",
          beFirstToShare: "¡Sé el primero en compartir algo!",
          anonymous: "Anónimo",
          copyright: "© 2025 Cloxious. Todos los derechos reservados.",
          // Validation messages
          postEmpty: "La publicación no puede estar vacía.",
          postTooLong: "La publicación debe tener menos de 512 caracteres.",
          nameRequired: "El nombre es obligatorio.",
          postSubmitSuccess: "¡Publicación enviada con éxito!",
          postSubmitFailed: "Error al enviar la publicación.",
          loadPostsFailed: "Error al cargar las publicaciones. Inténtalo de nuevo.",
          errorSubmitting: "Error al enviar la publicación. Inténtalo de nuevo."
        },
        it: {
          socialFeed: "Cloxious",
          shareThoughts: "Condividi i tuoi pensieri",
          yourName: "Il tuo nome",
          whatsOnMind: "A cosa stai pensando?",
          ctrlEnterToPost: "Premi Ctrl+Enter per pubblicare",
          post: "Pubblica",
          posting: "Pubblicando...",
          recentPosts: "Post Recenti",
          loading: "Caricamento...",
          loadMore: "Carica Altri",
          noPostsYet: "Ancora nessun post",
          beFirstToShare: "Sii il primo a condividere qualcosa!",
          anonymous: "Anonimo",
          copyright: "© 2025 Cloxious. Tutti i diritti riservati.",
          // Validation messages
          postEmpty: "Il post non può essere vuoto.",
          postTooLong: "Il post deve avere meno di 512 caratteri.",
          nameRequired: "Il nome è obbligatorio.",
          postSubmitSuccess: "Post inviato con successo!",
          postSubmitFailed: "Impossibile inviare il post.",
          loadPostsFailed: "Impossibile caricare i post. Riprova.",
          errorSubmitting: "Errore durante l'invio del post. Riprova."
        }
      };

      // Function to get the user's language
      function getUserLanguage() {
        const browserLang = navigator.language.split("-")[0];
        return translations[browserLang] ? browserLang : "en"; // Default to English if not supported
      }

      // Function to get translation
      function t(key) {
        const lang = getUserLanguage();
        return translations[lang][key] || translations["en"][key] || key;
      }
    </script>
    <script>
      let page = 1;
      const limit = 10;
      let isSubmitting = false;
      let isLoading = false;

      function formatTimeDifference(utcDateString) {
        const utcDate = new Date(utcDateString + " UTC");
        const now = new Date();
        const diffInSeconds = Math.floor((now - utcDate) / 1000);

        if (diffInSeconds < 60) {
          return `${diffInSeconds} seconds ago`;
        }
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
          return `${diffInMinutes} minutes ago`;
        }
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
          return `${diffInHours} hours ago`;
        }

        const currentYear = now.getFullYear();
        const postYear = utcDate.getFullYear();

        const locale = navigator.language;
        const options = { month: "long", day: "numeric" };
        if (currentYear !== postYear) {
          options.year = "numeric";
        }

        return utcDate.toLocaleDateString(locale, options);
      }

      async function fetchPosts(loadMore = false) {
        if (isLoading) return;

        isLoading = true;
        toggleLoadingState(true);

        try {
          const response = await fetch(`https://cloxious.cloxious.workers.dev/posts?page=${page}&limit=${limit}`);
          const data = await response.json();
          const postList = document.getElementById("post-list");

          if (!loadMore) {
            postList.innerHTML = "";
          }

          if (data.results.length === 0 && !loadMore) {
            postList.innerHTML = `
        <div class="flex flex-col items-center justify-center py-12 text-gray-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <p class="text-lg font-medium">${t("noPostsYet")}</p>
          <p class="mt-1">${t("beFirstToShare")}</p>
        </div>
      `;
          } else {
            data.results.forEach((post) => {
              const postElement = document.createElement("div");
              postElement.className = "p-5 border border-gray-200 rounded-lg bg-white mb-4 shadow-sm hover:shadow-md transition-shadow duration-200";
              postElement.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0 mr-3">
              <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-600 font-bold">
                ${post.author ? post.author.charAt(0).toUpperCase() : "?"}
              </div>
            </div>
            <div class="flex-1">
              <div class="flex items-center mb-1">
                <h3 class="font-medium text-gray-900">${post.author || t("anonymous")}</h3>
              </div>
              <p class="text-gray-800 whitespace-pre-wrap break-words">${post.content}</p>
              <div class="mt-2 flex items-center text-gray-500 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>${formatTimeDifference(post.created_at)}</span>
              </div>
            </div>
          </div>
        `;
              postList.appendChild(postElement);
            });
          }

          if (data.results.length === limit) {
            document.getElementById("load-more").classList.remove("hidden");
          } else {
            document.getElementById("load-more").classList.add("hidden");
          }
        } catch (error) {
          console.error("Error fetching posts:", error);
          document.getElementById("error-message").textContent = t("loadPostsFailed");
          document.getElementById("error-alert").classList.remove("hidden");
          setTimeout(() => {
            document.getElementById("error-alert").classList.add("hidden");
          }, 5000);
        } finally {
          isLoading = false;
          toggleLoadingState(false);
        }
      }

      async function submitPost() {
        if (isSubmitting) return;

        const textarea = document.getElementById("post-text");
        const authorInput = document.getElementById("author-name");
        const content = textarea.value.trim();
        const author = authorInput.value.trim();
        const charCount = document.getElementById("char-count");
        const submitBtn = document.getElementById("submit-btn");

        if (content.length === 0) {
          showError(t("postEmpty"));
          return;
        }

        if (content.length > 512) {
          showError(t("postTooLong"));
          return;
        }

        if (author.length === 0) {
          showError(t("nameRequired"));
          return;
        }

        isSubmitting = true;
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    ${t("posting")}
  `;

        try {
          const response = await fetch("https://cloxious.cloxious.workers.dev/posts", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content, author })
          });

          if (response.ok) {
            textarea.value = "";
            updateCharCount();
            page = 1;
            await fetchPosts();
            showSuccess(t("postSubmitSuccess"));
          } else {
            showError(t("postSubmitFailed"));
          }
        } catch (error) {
          console.error("Error submitting post:", error);
          showError(t("errorSubmitting"));
        } finally {
          isSubmitting = false;
          submitBtn.disabled = false;
          submitBtn.innerHTML = t("post");
        }
      }

      function loadMorePosts() {
        page++;
        fetchPosts(true);
      }

      function updateCharCount() {
        const textarea = document.getElementById("post-text");
        const charCount = document.getElementById("char-count");
        const count = textarea.value.length;
        charCount.textContent = `${count}/512`;

        if (count > 512) {
          charCount.classList.add("text-red-500");
          charCount.classList.remove("text-gray-500");
        } else if (count > 450) {
          charCount.classList.add("text-yellow-500");
          charCount.classList.remove("text-gray-500", "text-red-500");
        } else {
          charCount.classList.add("text-gray-500");
          charCount.classList.remove("text-red-500", "text-yellow-500");
        }
      }

      function toggleLoadingState(isLoading) {
        const loadingIndicator = document.getElementById("loading-indicator");
        const loadMoreBtn = document.getElementById("load-more");

        if (isLoading) {
          loadingIndicator.classList.remove("hidden");
          if (page > 1) {
            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        ${t("loading")}
      `;
          }
        } else {
          loadingIndicator.classList.add("hidden");
          if (page > 1) {
            loadMoreBtn.disabled = false;
            loadMoreBtn.innerHTML = t("loadMore");
          }
        }
      }

      function showError(message) {
        const errorAlert = document.getElementById("error-alert");
        const errorMessage = document.getElementById("error-message");

        errorMessage.textContent = message;
        errorAlert.classList.remove("hidden");

        setTimeout(() => {
          errorAlert.classList.add("hidden");
        }, 5000);
      }

      function showSuccess(message) {
        const successAlert = document.getElementById("success-alert");
        const successMessage = document.getElementById("success-message");

        successMessage.textContent = message;
        successAlert.classList.remove("hidden");

        setTimeout(() => {
          successAlert.classList.add("hidden");
        }, 3000);
      }

      function handleKeyDown(event) {
        if (event.key === "Enter" && (event.ctrlKey || event.metaKey)) {
          submitPost();
        }
      }

      window.onload = () => {
        fetchPosts();
        document.getElementById("post-text").addEventListener("input", updateCharCount);
        document.getElementById("post-text").addEventListener("keydown", handleKeyDown);
        updateCharCount();

        // Apply translations
        document.getElementById("app-title").textContent = t("socialFeed");
        document.getElementById("share-thoughts").textContent = t("shareThoughts");
        document.getElementById("author-name").placeholder = t("yourName");
        document.getElementById("post-text").placeholder = t("whatsOnMind");
        document.getElementById("keyboard-shortcut").textContent = t("ctrlEnterToPost");
        document.getElementById("submit-btn").textContent = t("post");
        document.getElementById("recent-posts").textContent = t("recentPosts");
        document.getElementById("loading-text").textContent = t("loading");
        document.getElementById("load-more").textContent = t("loadMore");
        document.getElementById("copyright").textContent = t("copyright");
      };
    </script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex justify-between items-center">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary-500" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z" />
              <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z" />
            </svg>
            <h1 class="ml-2 text-xl font-bold text-gray-800" id="app-title">Cloxious</h1>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <!-- Alerts -->
      <div id="error-alert" class="mb-4 p-4 rounded-md bg-red-50 border border-red-200 hidden" role="alert">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                clip-rule="evenodd"
              />
            </svg>
          </div>
          <div class="ml-3">
            <p id="error-message" class="text-sm text-red-700"></p>
          </div>
          <div class="ml-auto pl-3">
            <div class="-mx-1.5 -my-1.5">
              <button
                type="button"
                class="inline-flex rounded-md p-1.5 text-red-500 hover:bg-red-100 focus:outline-none"
                onclick="document.getElementById('error-alert').classList.add('hidden')"
              >
                <span class="sr-only">Dismiss</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="success-alert" class="mb-4 p-4 rounded-md bg-green-50 border border-green-200 hidden" role="alert">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path
                fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                clip-rule="evenodd"
              />
            </svg>
          </div>
          <div class="ml-3">
            <p id="success-message" class="text-sm text-green-700"></p>
          </div>
          <div class="ml-auto pl-3">
            <div class="-mx-1.5 -my-1.5">
              <button
                type="button"
                class="inline-flex rounded-md p-1.5 text-green-500 hover:bg-green-100 focus:outline-none"
                onclick="document.getElementById('success-alert').classList.add('hidden')"
              >
                <span class="sr-only">Dismiss</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Post Form -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
        <div class="p-5">
          <h2 class="text-lg font-semibold text-gray-800 mb-3" id="share-thoughts">Share your thoughts</h2>
          <div class="mb-3">
            <input
              type="text"
              id="author-name"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-300 focus:border-primary-500 transition-colors duration-200"
              placeholder="Your name"
              required
            />
          </div>
          <div class="relative">
            <textarea
              id="post-text"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-300 focus:border-primary-500 transition-colors duration-200 resize-none"
              rows="3"
              maxlength="512"
              placeholder="What's on your mind?"
            ></textarea>
            <div class="absolute bottom-3 right-3">
              <span id="char-count" class="text-xs text-gray-500">0/512</span>
            </div>
          </div>
          <div class="mt-3 flex justify-between items-center">
            <div class="text-xs text-gray-500" id="keyboard-shortcut">Press Ctrl+Enter to post</div>
            <button
              id="submit-btn"
              onclick="submitPost()"
              class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors duration-200 flex items-center"
            >
              Post
            </button>
          </div>
        </div>
      </div>

      <!-- Posts Section -->
      <div>
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-800" id="recent-posts">Recent Posts</h2>
          <div id="loading-indicator" class="hidden">
            <div class="flex items-center text-primary-600">
              <svg class="animate-spin -ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span id="loading-text">Loading...</span>
            </div>
          </div>
        </div>

        <div id="post-list" class="space-y-4"></div>

        <div class="mt-6 text-center">
          <button
            id="load-more"
            onclick="loadMorePosts()"
            class="px-6 py-2.5 bg-gray-700 text-white rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors duration-200 hidden"
          >
            Load More
          </button>
        </div>
      </div>
    </main>

    <footer class="bg-white border-t border-gray-200 mt-10">
      <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <p class="text-center text-sm text-gray-500" id="copyright">&copy; 2025 Cloxious. All rights reserved.</p>
      </div>
    </footer>
  </body>
</html>
