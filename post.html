<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post Details - Cloxious</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Translations for the application (add more languages as needed)
      const translations = {
        en: {
          socialFeed: "Cloxious",
          anonymous: "Anonymous",
          postNotFound: "Post not found.",
          commentPlaceholder: "Write your comment...",
          submitComment: "Submit Comment",
          loading: "Loading...",
          errorLoadingPost: "Error loading post.",
          commentSubmitSuccess: "Comment submitted successfully!",
          commentSubmitFailed: "Failed to submit comment.",
          noComments: "No comments yet.",
          like: "Like",
          dislike: "Dislike",
          actionFailed: "Action failed. Please try again."
        },
        es: {
          socialFeed: "Cloxious",
          anonymous: "Anónimo",
          postNotFound: "Publicación no encontrada.",
          commentPlaceholder: "Escribe tu comentario...",
          submitComment: "Enviar comentario",
          loading: "Cargando...",
          errorLoadingPost: "Error al cargar la publicación.",
          commentSubmitSuccess: "¡Comentario enviado con éxito!",
          commentSubmitFailed: "Error al enviar el comentario.",
          noComments: "Aún no hay comentarios.",
          like: "Me gusta",
          dislike: "No me gusta",
          actionFailed: "La acción falló. Por favor, inténtalo de nuevo."
        },
        it: {
          socialFeed: "Cloxious",
          anonymous: "Anonimo",
          postNotFound: "Post non trovato.",
          commentPlaceholder: "Scrivi il tuo commento...",
          submitComment: "Invia commento",
          loading: "Caricamento...",
          errorLoadingPost: "Errore nel caricamento del post.",
          commentSubmitSuccess: "Commento inviato con successo!",
          commentSubmitFailed: "Impossibile inviare il commento.",
          noComments: "Nessun commento ancora.",
          like: "Mi piace",
          dislike: "Non mi piace",
          actionFailed: "Azione fallita. Per favore riprova."
        }
      };

      function getUserLanguage() {
        const browserLang = navigator.language.split("-")[0];
        return translations[browserLang] ? browserLang : "en";
      }

      function t(key) {
        const lang = getUserLanguage();
        return translations[lang][key] || translations["en"][key] || key;
      }

      // Time formatting function
      function formatTimeDifference(utcDateString) {
        const isoDateString = utcDateString.replace(" ", "T") + "Z";
        const utcDate = new Date(isoDateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - utcDate) / 1000);

        if (diffInSeconds < 60) {
          return `${diffInSeconds} ${diffInSeconds === 1 ? "second" : "seconds"} ago`;
        }
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
          return `${diffInMinutes} ${diffInMinutes === 1 ? "minute" : "minutes"} ago`;
        }
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
          return `${diffInHours} ${diffInHours === 1 ? "hour" : "hours"} ago`;
        }
        const currentYear = now.getFullYear();
        const postYear = utcDate.getFullYear();
        const locale = navigator.language;
        const options = { month: "long", day: "numeric" };
        if (currentYear !== postYear) {
          options.year = "numeric";
        }
        return utcDate.toLocaleDateString(locale, options);
      }

      // Helper to get query parameters
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }
    </script>
    <script>
      let postId = getQueryParam("id");

      async function loadPost() {
        if (!postId) return;
        document.getElementById("post-container").innerHTML = `<p>${t("loading")}</p>`;
        try {
          const response = await fetch(`https://cloxious.cloxious.workers.dev/posts/${postId}`);
          const data = await response.json();
          if (!data.success || !data.post) {
            document.getElementById("post-container").innerHTML = `<p>${t("postNotFound")}</p>`;
            return;
          }
          const post = data.post;
          // Build the like/dislike buttons with updated counts
          const postDetailsHtml = `
            <div class="bg-white rounded-lg shadow p-5 mb-6">
              <h2 class="font-bold text-xl">${post.author || t("anonymous")}</h2>
              <p class="mt-2 text-gray-800">${post.content}</p>
              <p class="mt-2 text-sm text-gray-500">${formatTimeDifference(post.created_at)}</p>
              <div class="mt-3 flex items-center space-x-4">
                <div class="flex items-center">
                  <button id="like-${post.id}" onclick="likePost('${
            post.id
          }')" class="inline-flex items-center p-1 rounded-md text-gray-500 hover:text-green-600 hover:bg-green-50 transition-colors duration-200" aria-label="${t(
            "like"
          )}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20" />
                    </svg>
                  </button>
                  <span id="like-count">${post.likes || 0}</span>
                </div>
                <div class="flex items-center">
                  <button id="dislike-${post.id}" onclick="dislikePost('${
            post.id
          }')" class="inline-flex items-center p-1 rounded-md text-gray-500 hover:text-red-600 hover:bg-red-50 transition-colors duration-200" aria-label="${t(
            "dislike"
          )}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7" />
                    </svg>
                  </button>
                  <span id="dislike-count">${post.dislikes || 0}</span>
                </div>
                <div class="flex items-center">
                  <span>${post.comment_count || 0} ${post.comment_count === 1 ? "Comment" : "Comments"}</span>
                </div>
              </div>
            </div>
          `;
          // Build the comment form and comments section
          let commentsHtml = "";
          if (post.comments && post.comments.length) {
            post.comments.forEach((comment) => {
              commentsHtml += `
                <div class="p-3 border-b border-gray-200">
                  <p class="font-medium">${comment.author || t("anonymous")}</p>
                  <p class="text-gray-700">${comment.content}</p>
                  <p class="text-xs text-gray-500">${formatTimeDifference(comment.created_at)}</p>
                </div>
              `;
            });
          } else {
            commentsHtml = `<p class="text-gray-500 p-3">${t("noComments")}</p>`;
          }
          document.getElementById("post-container").innerHTML = `
            ${postDetailsHtml}
            <!-- Comment Form -->
            <div class="bg-white rounded-lg shadow p-5 mb-6">
              <h3 class="font-semibold text-lg mb-3">${t("submitComment")}</h3>
              <input type="text" id="comment-author" placeholder="Your name" class="w-full p-2 mb-3 border border-gray-300 rounded" />
              <textarea id="comment-content" placeholder="${t(
                "commentPlaceholder"
              )}" class="w-full p-2 mb-3 border border-gray-300 rounded" rows="3"></textarea>
              <button onclick="submitComment()" class="px-4 py-2 bg-primary-600 text-white rounded">${t("submitComment")}</button>
            </div>
            <!-- Comments Section -->
            <div>
              <h3 class="font-semibold text-lg mb-3">Comments</h3>
              <div id="comments-container" class="mb-6">
                ${commentsHtml}
              </div>
            </div>
          `;
        } catch (error) {
          console.error("Error loading post:", error);
          document.getElementById("post-container").innerHTML = `<p>${t("errorLoadingPost")}</p>`;
        }
      }

      async function submitComment() {
        const author = document.getElementById("comment-author").value.trim();
        const content = document.getElementById("comment-content").value.trim();
        if (!author || !content) return; // Simple validation
        try {
          const response = await fetch(`https://cloxious.cloxious.workers.dev/posts/${postId}/comments`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ author, content })
          });
          const data = await response.json();
          if (data.success) {
            alert(t("commentSubmitSuccess"));
            loadPost(); // Reload to update comments and counts
          } else {
            alert(t("commentSubmitFailed"));
          }
        } catch (error) {
          console.error("Error submitting comment:", error);
          alert(t("commentSubmitFailed"));
        }
      }

      async function likePost(postId) {
        try {
          const response = await fetch(`https://cloxious.cloxious.workers.dev/posts/${postId}/like`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          if (response.ok) {
            const likeCountElem = document.getElementById("like-count");
            likeCountElem.textContent = parseInt(likeCountElem.textContent) + 1;
          } else {
            alert(t("actionFailed"));
          }
        } catch (error) {
          console.error("Error liking post:", error);
          alert(t("actionFailed"));
        }
      }

      async function dislikePost(postId) {
        try {
          const response = await fetch(`https://cloxious.cloxious.workers.dev/posts/${postId}/dislike`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          if (response.ok) {
            const dislikeCountElem = document.getElementById("dislike-count");
            dislikeCountElem.textContent = parseInt(dislikeCountElem.textContent) + 1;
          } else {
            alert(t("actionFailed"));
          }
        } catch (error) {
          console.error("Error disliking post:", error);
          alert(t("actionFailed"));
        }
      }

      window.onload = loadPost;
    </script>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow-sm">
      <div class="max-w-3xl mx-auto p-4">
        <h1 class="text-xl font-bold" id="app-title">${t("socialFeed")}</h1>
      </div>
    </header>
    <main class="max-w-3xl mx-auto p-4">
      <div id="post-container"></div>
    </main>
    <footer class="bg-white border-t mt-10">
      <div class="max-w-3xl mx-auto p-4">
        <p class="text-center text-sm text-gray-500">&copy; 2025 Cloxious. All rights reserved.</p>
      </div>
    </footer>
  </body>
</html>
